{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import path from 'path';\nimport fs from 'fs-extra';\nimport { createFilter } from 'rollup-pluginutils';\nimport posthtml from 'posthtml';\nimport matchHelper from 'posthtml-match-helper';\n\n\nconst pluginName = 'posthtml-multi';\n\n\nexport default function({\n\twatch = false,\n\timportPath,\n\toptions: optionList = [{}],\n}) {\n\tconst output = {};\n\tlet options = Array.isArray(optionList)\n\t\t? optionList\n\t\t: [optionList];\n\n\tfor (let config of options) {\n\t\tconfig._filter = config.include\n\t\t\t? createFilter(config.include, config.exclude)\n\t\t\t: createFilter('**/*.html', config.exclude);\n\t}\n\n\n\tconst plugin = {\n\t\tname: pluginName,\n\n\t\tasync resolveImport(filePath, from) {\n\t\t\t// eslint-disable-next-line multiline-ternary\n\t\t\tconst parent = from ? from : filePath;\n\t\t\tif (path.isAbsolute(filePath) && await fs.pathExists(filePath)) return filePath;\n\t\t\tif (importPath) {\n\t\t\t\tconst fromImportPath = path.join(path.resolve(importPath), filePath);\n\t\t\t\tif (await fs.pathExists(fromImportPath)) return fromImportPath;\n\t\t\t}\n\t\t\tconst fromCWD = path.resolve(filePath);\n\t\t\tconst fromEntry = path.join(path.resolve(path.dirname(parent)), filePath);\n\t\t\tif (await fs.pathExists(fromCWD)) return fromCWD;\n\t\t\telse if (await fs.pathExists(fromEntry)) return fromEntry;\n\t\t\treturn null;\n\t\t},\n\n\t\tposthtmlHook(from, context) {\n\t\t\treturn (tree) => new Promise((resolve) => {\n\t\t\t\tconst promises = [];\n\t\t\t\ttree.match(matchHelper('module[href],include[src],extends[src]'), (node) => {\n\t\t\t\t\tpromises.push(new Promise((resolveTask) => {\n\t\t\t\t\t\tconst href = node.attrs.href\n\t\t\t\t\t\t\t? node.attrs.href\n\t\t\t\t\t\t\t: node.attrs.src;\n\t\t\t\t\t\tthis.resolveImport(href, from).then((nodePath) => {\n\t\t\t\t\t\t\tif (nodePath !== null) {\n\t\t\t\t\t\t\t\tcontext.addWatchFile(nodePath);\n\t\t\t\t\t\t\t\tfs.readFile(nodePath).then((code) => {\n\t\t\t\t\t\t\t\t\tposthtml([this.posthtmlHook(nodePath, context)])\n\t\t\t\t\t\t\t\t\t\t.process(code)\n\t\t\t\t\t\t\t\t\t\t.then(() => resolveTask())\n\t\t\t\t\t\t\t\t\t\t.catch((err) => context.error(err));\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.catch((err) => context.error(err));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch((err) => context.error(err));\n\t\t\t\t\t}));\n\t\t\t\t});\n\t\t\t\tPromise.all(promises).then(() => resolve(tree))\n\t\t\t\t\t.catch((err) => context.error(err));\n\t\t\t});\n\t\t},\n\n\t\tasync transform(code, id) {\n\t\t\tconst matchingConfigs = [];\n\t\t\tconst parsedList = [];\n\n\t\t\tfor (let config of options) {\n\t\t\t\tif (config._filter(id)) {\n\t\t\t\t\tmatchingConfigs.push(config);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!matchingConfigs.length) return null;\n\n\t\t\tfor (let config of matchingConfigs) {\n\t\t\t\tconst parsed = (await posthtml(config.plugins || []).process(code, {\n\t\t\t\t\tparser: config.parser,\n\t\t\t\t\tdirectives: config.directives,\n\t\t\t\t})).html;\n\t\t\t\tparsedList.push(parsed);\n\t\t\t\tif (config.extract) {\n\t\t\t\t\tif (!Array.isArray(output[id])) output[id] = [];\n\t\t\t\t\toutput[id].push({\n\t\t\t\t\t\tcode: parsed,\n\t\t\t\t\t\textract: config.extract,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tif (watch) {\n\t\t\t\t\tawait posthtml([plugin.posthtmlHook(id, this)]).process(code, {\n\t\t\t\t\t\tparser: config.parser,\n\t\t\t\t\t\tdirectives: config.directives,\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn {\n\t\t\t\tcode: matchingConfigs.some((config) => config.extract)\n\t\t\t\t\t? 'export default \\'\\''\n\t\t\t\t\t: `export default ${JSON.stringify(parsedList[0])}`,\n\t\t\t\tmap: { mappings: '' },\n\t\t\t};\n\t\t},\n\n\t\tasync generateBundle(opts, bundle, isWrite) {\n\t\t\tif (!isWrite) return;\n\n\t\t\tconst getFileName = (file, extract) => {\n\t\t\t\tconst resolvePath = (dir, ...segment) => path.resolve(path.join(dir, ...segment));\n\t\t\t\tconst dir = opts.dir || path.dirname(opts.file);\n\t\t\t\tconst name = path.basename(file, path.extname(file));\n\t\t\t\tif (typeof extract === 'string') {\n\t\t\t\t\tif (path.isAbsolute(extract)) {\n\t\t\t\t\t\tif (path.extname(extract)) return extract;\n\t\t\t\t\t\treturn `${path.join(extract, name)}.html`;\n\t\t\t\t\t}\n\t\t\t\t\tif (path.extname(extract)) return resolvePath(dir, extract);\n\t\t\t\t\treturn resolvePath(dir, extract, `${name}.html`);\n\t\t\t\t}\n\t\t\t\treturn resolvePath(dir, `${name}.html`);\n\t\t\t};\n\n\t\t\tfor (let [id, codeList] of Object.entries(output)) {\n\t\t\t\tfor (let i = 0; i < codeList.length; i++) {\n\t\t\t\t\tlet assetName = getFileName(id, codeList[i].extract, i);\n\t\t\t\t\tlet codeFile = {\n\t\t\t\t\t\tfileName: assetName,\n\t\t\t\t\t\tisAsset: true,\n\t\t\t\t\t\tsource: codeList[i].code,\n\t\t\t\t\t};\n\t\t\t\t\tbundle[assetName] = codeFile;\n\n\t\t\t\t\tconst jsName = `${path.basename(id, path.extname(id))}.js`;\n\t\t\t\t\tif (bundle[jsName] && bundle[jsName].facadeModuleId === id && bundle[jsName].isEntry) {\n\t\t\t\t\t\tdelete bundle[jsName];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tdelete output[id];\n\t\t\t}\n\t\t}\n\t};\n\treturn plugin;\n}\n"],"names":["const","let","createFilter","this","config"],"mappings":"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"}